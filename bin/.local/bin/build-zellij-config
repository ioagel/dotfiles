#!/bin/bash

set -e # Exit immediately if a command exits with a non-zero status.
set -u # Exit if unset variable is used

# --- Script Purpose ---
# Generates the Zellij config.kdl file from a template,
# replacing the theme placeholder with the specified theme name.

# --- Usage Function ---
usage() {
    echo "Usage: $0 [-t|--theme] <theme_name>" >&2
    echo "  Builds the Zellij config with the specified theme." >&2
    exit 1
}

# --- Argument Parsing ---
THEME_NAME=""

# Manual loop to handle both -t and --theme
while [ $# -gt 0 ]; do
    case "$1" in
    -t | --theme)
        if [ -n "$2" ]; then
            THEME_NAME="$2"
            shift # past argument
            shift # past value
        else
            echo "Error: Option '$1' requires an argument." >&2
            usage
        fi
        ;;
    --theme=*)
        THEME_NAME="${1#*=}" # Extract value after =
        shift                # past argument=value
        ;;
    -*)
        echo "Error: Unknown option '$1'" >&2
        usage
        ;;
    *)
        echo "Error: Unexpected argument '$1'" >&2
        usage
        ;;
    esac
done

# Check if theme name was provided
if [ -z "$THEME_NAME" ]; then
    echo "Error: Theme name must be specified with -t or --theme." >&2
    usage
fi

# --- Configuration ---
# Set config path with fallback to default
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}"
ZELLIJ_DIR="$CONFIG_DIR/zellij"
TEMPLATE_FILE="$ZELLIJ_DIR/config.kdl.template"
CONFIG_FILE="$ZELLIJ_DIR/config.kdl"
PLACEHOLDER="__ZELLIJ_CURRENT_THEME__"

# --- Validation ---
# Check if template file exists
if [ ! -f "$TEMPLATE_FILE" ]; then
    echo "Error: Template file not found: $TEMPLATE_FILE" >&2
    exit 1
fi

# Ensure the Zellij config directory exists
mkdir -p "$ZELLIJ_DIR"

# --- Build Config ---
echo "Building Zellij config '$CONFIG_FILE' with theme '$THEME_NAME'..."

# Add Autogenerated header to the output file
{
    echo "// AUTOGENERATED by build-zellij-config, DO NOT EDIT MANUALLY"
    echo "// Instead, edit the template file: ${TEMPLATE_FILE}"
    echo ""
} >"$CONFIG_FILE"

# Generate config.kdl from template, replacing the placeholder
sed "s/$PLACEHOLDER/$THEME_NAME/g" "$TEMPLATE_FILE" >>"$CONFIG_FILE"

echo "Zellij config built successfully with theme: $THEME_NAME"

exit 0
