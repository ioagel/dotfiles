#!/usr/bin/env bash
# Generates the Zellij config.kdl file from a template,
# replacing the theme placeholder with the specified theme name.

set -e # Exit immediately if a command exits with a non-zero status.
set -u # Exit if unset variable is used

# Common utility functions
# shellcheck disable=SC1090
source ~/.local/bin/_script_utils.sh

THEME="gruvbox-dark"   # Default theme
SEND_NOTIFICATION=true # Default: send notification

# --- Usage Function ---
usage() {
    local script_name
    script_name=$(basename "$0")
    echo "Usage: $script_name [-t|--theme <theme_name>] [-q|--quiet] [-h|--help]" >&2
    echo "  Builds the Zellij config with the specified theme." >&2
    echo "  Options:" >&2
    echo "    -t, --theme <theme_name>  Specify the initial theme to activate (default: ${THEME})." >&2
    echo "    -q, --quiet               Suppress the final notification message." >&2
    echo "    -h, --help                Show this help message." >&2
    exit 1
}

# --- Argument Parsing ---
# Manual loop to handle both -t and --theme
while [ $# -gt 0 ]; do
    case "$1" in
    -t | --theme)
        if [[ -n "$2" && "$2" != -* ]]; then
            THEME="$2"
            shift # past argument
            shift # past value
        else
            echo "Error: Option '$1' requires an argument." >&2
            usage
        fi
        ;;
    -q | --quiet)
        SEND_NOTIFICATION=false
        shift # past argument
        ;;
    -h | --help)
        usage
        ;;
    --) # End of options
        shift
        break
        ;;
    -*)
        echo "Error: Unknown option '$1'" >&2
        usage
        ;;
    *)
        echo "Error: Unexpected argument '$1'" >&2
        usage
        ;;
    esac
done

# --- Configuration ---
# Set config path with fallback to default
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}"
ZELLIJ_DIR="$CONFIG_DIR/zellij"
TEMPLATE_FILE="$ZELLIJ_DIR/config.kdl.template"
CONFIG_FILE="$ZELLIJ_DIR/config.kdl"
PLACEHOLDER="__ZELLIJ_CURRENT_THEME__"

# Dependency Checks
check_command "notify-send" "Please install: libnotify"

# Check if template file exists
if [ ! -f "$TEMPLATE_FILE" ]; then
    error "Template file not found: $TEMPLATE_FILE"
fi

# Ensure the Zellij config directory exists
mkdir -p "$ZELLIJ_DIR"

# --- Build Config ---
log "Building Zellij config '$CONFIG_FILE' with theme '$THEME'..."

# Add Autogenerated header to the output file
{
    echo "// AUTOGENERATED by build-zellij-config, DO NOT EDIT MANUALLY"
    echo "// Instead, edit the template file: ${TEMPLATE_FILE}"
    echo ""
} >"$CONFIG_FILE"

# Generate config.kdl from template, replacing the placeholder
sed "s/$PLACEHOLDER/$THEME/g" "$TEMPLATE_FILE" >>"$CONFIG_FILE"

log "Zellij config built successfully with theme: $THEME"

# Send notification
if [[ "$SEND_NOTIFICATION" = true ]]; then
    log "Sending notification..."
    notify-send "Zellij Theme Applied" "Switched to '$THEME' theme."
fi
