#!/usr/bin/env bash
# shellcheck disable=SC1090 disable=SC1091

set -e

# Utility functions
source ~/.local/lib/utils.sh
source ~/.local/lib/extract.sh

# Dependency Checks
check_command "envsubst" "Please install gettext (for envsubst)"

# --- Rofi Config Update Logic ---

update_rofi_config() {
    local rofi_config_dir="$HOME/.config/rofi"
    local template_file="${rofi_config_dir}/base.rasi.template"
    local target_file="${rofi_config_dir}/base.rasi"
    local temp_envsubst_output_file=/tmp/base.rasi.envsubst.tmp  # Temporary file for envsubst output
    local temp_cleaned_body_file=/tmp/base.rasi.cleaned_body.tmp # Temporary file for cleaned body

    log "Updating Rofi configuration..."

    if [ ! -f "$HOME/.config/themes/active-theme.sh" ]; then
        error "Active theme file not found: $HOME/.config/themes/active-theme.sh. Cannot source theme variables."
    fi
    # Source active-theme.sh to ensure ROFI_* variables are set
    # shellcheck disable=SC1090
    source "$HOME/.config/themes/active-theme.sh"

    if [ -f "$template_file" ]; then
        # Important: list all variables to be substituted, space-separated
        # shellcheck disable=SC2016
        local vars_to_substitute='$ROFI_BASE $ROFI_TEXT $ROFI_RED $ROFI_LIGHTBG $ROFI_LIGHTFG $ROFI_ACTIVE_FOREGROUND $ROFI_SELECTED_ACTIVE_BACKGROUND $ROFI_ALTERNATE_ACTIVE_FOREGROUND'

        envsubst "$vars_to_substitute" <"$template_file" >"$temp_envsubst_output_file"
        # Clean the envsubst output into a separate temporary file for the body
        clean_config_file "$temp_envsubst_output_file" >"$temp_cleaned_body_file"

        # Write the autogenerated header to the target file (overwrite)
        echo "// AUTOGENERATED by $(basename "$0"), DO NOT EDIT MANUALLY" >"$target_file"
        echo "// Instead, edit the template file: $template_file" >>"$target_file"

        # Append the cleaned body to the target file
        cat "$temp_cleaned_body_file" >>"$target_file"

        rm -f "$temp_envsubst_output_file" # Clean up first temp file
        rm -f "$temp_cleaned_body_file"    # Clean up second temp file

        log "Rofi config '$target_file' generated from template."
    else
        error "Rofi template file not found: ${template_file}"
    fi
}

# --- Main ---
update_rofi_config
