#!/usr/bin/env bash

# Get current GNOME theme setting
current_theme=$(gsettings get org.gnome.desktop.interface color-scheme)

# Toggle theme
if [[ $current_theme == *"light"* ]]; then
  # Current theme is light, switch to dark
  gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark'

  # Update i3 config to dark
  build-i3-config -t gruvbox-dark

  # Update Zellij config to use dark theme
  build-zellij-config -t gruvbox-dark

  # Update xsettingsd config to use dark theme (GTK Apps)
  ln -sf ~/.config/xsettingsd/themes/gruvbox-dark.conf ~/.config/xsettingsd/xsettingsd.conf

  # Update Polybar theme to dark
  ln -sf "$HOME/.config/polybar/modules/themes/gruvbox-dark.ini" "$HOME/.config/polybar/modules/colors.ini"

  # Update Yazi theme to dark
  ln -sf ~/.config/yazi/themes/theme-gruvbox-dark.toml ~/.config/yazi/theme.toml

  echo "Switched to dark theme"
else
  # Current theme is dark, switch to light
  gsettings set org.gnome.desktop.interface color-scheme 'prefer-light'

  # Update i3 config to light
  build-i3-config -t catppuccin-latte

  # Update Zellij config to use light theme
  build-zellij-config -t catppuccin-latte

  # Update xsettingsd config to use light theme (GTK Apps)
  ln -sf ~/.config/xsettingsd/themes/catppuccin-latte.conf ~/.config/xsettingsd/xsettingsd.conf

  # Update Polybar theme to light
  ln -sf "$HOME/.config/polybar/modules/themes/catppuccin-latte.ini" "$HOME/.config/polybar/modules/colors.ini"

  # Update Yazi theme to light (HACK: Zellij and Yazi light theme incompatibility forces this)
  ln -sf ~/.config/yazi/themes/theme-catppuccin-latte.toml ~/.config/yazi/theme.toml

  echo "Switched to light theme"
fi

# Find running Neovim instances and update their colorscheme
# This requires the neovim-remote package (yay -S neovim-remote)
if command -v nvr &>/dev/null; then
  # Find all Neovim server sockets
  for socket in /tmp/nvimsocket* /run/user/$(id -u)/nvim*; do
    if [ -e "$socket" ]; then
      # Send UpdateColorscheme command to each Neovim instance
      NVIM_LISTEN_ADDRESS="$socket" nvr --remote-send '<Esc>:UpdateColorscheme<CR>' &>/dev/null
    fi
  done
else
  echo "neovim-remote not found. Install with: yay -S neovim-remote"
  echo "Neovim instances will update their theme on the next periodic check"
fi

# Reload xsettingsd to apply changes to GTK apps
killall -HUP xsettingsd

# Reload polybar
polybar-msg cmd restart &>/dev/null

# Reload i3 config
i3-msg reload
